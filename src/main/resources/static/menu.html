<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Billing Portal</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <link rel="stylesheet" href="menu.css" />
</head>
<body>
  <div class="main-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo">
        <img src="https://img.icons8.com/?size=100&id=BfxcvceDl78F&format=png&color=000000" alt="Remindr Logo" />
      </div>

      <ul class="menu">
        <li class="active" onclick="showSection('dashboard')">Dashboard</li>
        <li onclick="showSection('invoices')">Invoices</li>
        <li onclick="showSection('generate-bill')">Generate Bill</li>
        <li onclick="showSection('bulk-upload')">Bulk Bill Upload</li>
      </ul>
    </aside>

    <!-- Main Content -->
    <section class="content">
      <div class="header">
        <h2>Welcome back, <span id="user-name">Loading...</span>!</h2>
        <p id="project-name" style="color: gray; font-size: 14px;"></p>
      </div>

      <!-- Dashboard Section -->
      <div id="dashboard" class="section">
        <div class="dashboard-cards">
          <div class="card">
            <h3>Invoices Created</h3>
            <p id="invoices-count">--</p>
          </div>
          <div class="card">
            <h3>Payments Pending</h3>
            <p id="pending-amount">--</p>
          </div>
          <div class="card">
            <h3>Reminders Sent</h3>
            <p id="reminders-sent">--</p>
          </div>
        </div>

        <div class="analytics-section">
          <div class="analytics-card">
            <h3>Invoice Reminders</h3>
            <div class="reminder-stats">
              <p class="big-number" id="reminders-total">15</p>
              <p class="sub-label">Sent</p>
            </div>
            <canvas id="reminders-chart"></canvas>
          </div>

          <div class="analytics-card">
            <h3>Invoice Analytics</h3>
            <canvas id="invoice-pie-chart"></canvas>
            <div class="pie-legend">
              <div class="legend-item">
                <span class="legend-color" style="background: #4285F4;"></span>
                <span>Fulfilled: <strong id="fulfilled-count">0</strong></span>
              </div>
              <div class="legend-item">
                <span class="legend-color" style="background: #D3D3D3;"></span>
                <span>Unfulfilled: <strong id="unfulfilled-count">0</strong></span>
              </div>
            </div>
          </div>
        </div>

        <div class="payments-section">
          <h3>Payments</h3>
          <table>
            <thead>
              <tr>
                <th>Bill No</th>
                <th>Customer Name</th>
                <th>Amount</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="payments-table"></tbody>
          </table>
        </div>
      </div>

      <!-- Invoices Section -->
      <div id="invoices" class="section" style="display:none;">
  <h2>All Invoices</h2>
  <div style="margin-bottom: 10px;">
  <button id="exportBtn" style="background:#34A853; color:white; padding:8px 15px; border:none; border-radius:6px; cursor:pointer; font-weight:500;">Export to Excel</button>
</div>

  <table id="billsTable" class="display">
    <thead>
      <tr>
        <th>Bill No</th>
        <th>Customer Name</th>
        <th>Customer Email</th>
        <th>Address</th>
        <th>Phone</th>
        <th>GSTIN</th>
        <th>Due Date</th>
        <th>Amount</th>
        <th>Paid</th>
        <th>Mails Sent</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>


      <!-- Generate Bill Section -->
      <div id="generate-bill" class="section" style="display:none;">
        <h2>Generate Customer Bill</h2>
        <form id="billForm" method="POST" action="/api/download-bill" style="background:white; padding:20px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); max-width:600px;">
          <div class="form-group" style="margin-bottom:15px;">
            <label for="email" style="display:block; margin-bottom:5px; font-weight:500;">Customer Email:</label>
            <input type="email" id="email" name="email" required style="width:100%; padding:10px; border:1px solid #ccc; border-radius:4px;"/>
          </div>

          <div class="form-group" style="margin-bottom:15px;">
            <label for="customerName" style="display:block; margin-bottom:5px; font-weight:500;">Customer Name:</label>
            <input type="text" id="customerName" name="customerName" required style="width:100%; padding:10px; border:1px solid #ccc; border-radius:4px;"/>
          </div>

          <div class="form-group" style="margin-bottom:15px;">
            <label for="address" style="display:block; margin-bottom:5px; font-weight:500;">Address:</label>
            <input type="text" id="address" name="address" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:4px;"/>
          </div>

          <div class="form-group" style="margin-bottom:15px;">
            <label for="phone" style="display:block; margin-bottom:5px; font-weight:500;">Phone Number:</label>
            <input type="tel" id="phone" name="phone" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:4px;"/>
          </div>

          <div class="form-group" style="margin-bottom:15px;">
            <label for="gstin" style="display:block; margin-bottom:5px; font-weight:500;">GSTIN:</label>
            <input type="text" id="gstin" name="gstin" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:4px;"/>
          </div>

          <div class="form-group" style="margin-bottom:15px;">
            <label for="dueDate" style="display:block; margin-bottom:5px; font-weight:500;">Due Date:</label>
            <input type="date" id="dueDate" name="dueDate" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:4px;"/>
          </div>

          <div class="form-group" style="margin-bottom:20px;">
            <label for="amount" style="display:block; margin-bottom:5px; font-weight:500;">Bill Amount:</label>
            <input type="number" step="0.01" id="amount" name="amount" required style="width:100%; padding:10px; border:1px solid #ccc; border-radius:4px;"/>
          </div>

          <button type="submit" id="generateBillBtn" style="background:#4285F4; color:white; padding:10px 20px; border:none; border-radius:6px; cursor:pointer; font-weight:500;">Generate Bill</button>
        </form>
        <div id="billGenerateStatus" style="margin-top:20px; padding:15px; border-radius:6px; font-weight:500; display:none;"></div>
      </div>

      <!-- Bulk Upload Section -->
      <div id="bulk-upload" class="section" style="display:none;">
        <h2>üìä Bulk Bill Upload</h2>
        
        <div class="info-box" style="background: #e8f4f8; border-left: 4px solid #2196F3; padding: 15px; margin-bottom: 25px; border-radius: 4px;">
          <h4 style="color: #1976D2; margin-bottom: 8px; font-size: 0.95rem;">‚ÑπÔ∏è Instructions:</h4>
          <ul style="margin-left: 20px; color: #555; font-size: 0.9rem;">
            <li style="margin-bottom: 5px;">Upload an Excel file (.xlsx format) containing bill data</li>
            <li style="margin-bottom: 5px;">Ensure your Excel file has the required columns</li>
            <li style="margin-bottom: 5px;">Enter the owner's email address for bill assignment</li>
          </ul>
        </div>

        <form id="bulkUploadForm" style="background:white; padding:30px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); max-width:600px;">
          <div class="form-group" style="margin-bottom:20px;">
            <label for="ownerEmail" style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Owner Email: *</label>
            <input 
              type="email" 
              id="ownerEmail" 
              name="ownerEmail" 
              placeholder="Enter owner's email address"
              required 
              style="width:100%; padding:12px 15px; border:2px solid #e0e0e0; border-radius:6px; font-size:1rem; transition: all 0.3s ease;"
            />
          </div>
          
          <div class="form-group" style="margin-bottom:25px;">
            <label for="file" style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Select Excel File: *</label>
            <input 
              type="file" 
              id="file" 
              name="file" 
              accept=".xlsx" 
              required 
              style="width:100%; padding:12px 15px; border:2px dashed #e0e0e0; border-radius:6px; cursor:pointer; background:#f9f9f9;"
            />
          </div>
          
          <button 
            type="submit" 
            id="uploadBtn"
            style="width:100%; background:linear-gradient(135deg, #34A853 0%, #2d8e47 100%); color:white; padding:14px 20px; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:1rem; box-shadow:0 4px 15px rgba(52, 168, 83, 0.3); transition: all 0.3s ease;"
          >
            Upload Excel
          </button>
        </form>
        
        <div id="uploadStatus" style="margin-top:20px; padding:15px; border-radius:6px; font-weight:500; display:none;"></div>
      </div>

    </section>
  </div>

  <script>
    // Toggle visible section
    function showSection(id) {
      document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
      document.getElementById(id).style.display = 'block';
      document.querySelectorAll('.menu li').forEach(li => li.classList.remove('active'));
      document.querySelector(`.menu li[onclick="showSection('${id}')"]`).classList.add('active');
    }

    // Load Bills
    async function loadBills() {
      try {
        const response = await fetch('/api/track-bills');
        if (!response.ok) throw new Error("Failed to fetch bills");
        const bills = await response.json();

        const pendingBills = bills.filter(b => !b.isPaid);
        const totalPending = pendingBills.reduce((sum, b) => sum + b.amount, 0);
        const paidBills = bills.filter(b => b.isPaid);

        document.getElementById("invoices-count").textContent = bills.length;
        document.getElementById("pending-amount").textContent = `‚Çπ${totalPending.toLocaleString()}`;
        // Calculate total mails sent across all invoices
        const totalMailsSent = bills.reduce((sum, b) => sum + (b.mailsSent || 0), 0);
        document.getElementById("reminders-sent").textContent = totalMailsSent;
        document.getElementById("reminders-total").textContent = totalMailsSent;


        document.getElementById("fulfilled-count").textContent = paidBills.length;
        document.getElementById("unfulfilled-count").textContent = pendingBills.length;

        const dashTable = document.getElementById("payments-table");
        dashTable.innerHTML = "";
        bills.slice(0, 5).forEach(bill => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${bill.id}</td>
            <td>${bill.customerName}</td>
            <td>‚Çπ${bill.amount.toFixed(2)}</td>
            <td class="${bill.isPaid ? 'paid' : 'pending'}">${bill.isPaid ? 'Paid' : 'Pending'}</td>
          `;
          dashTable.appendChild(row);
        });

        const tbody = document.querySelector('#billsTable tbody');
        tbody.innerHTML = '';
        bills.forEach(bill => {
          const dueDate = new Date(bill.dueDate);
          const today = new Date();
          let paidStatus = bill.isPaid ? 'Yes' : 'No';
          let rowClass = '';

          // Check if overdue
          if (!bill.isPaid && dueDate < today) {
             paidStatus = '<span style="color: red; font-weight: bold;">Overdue</span>';
          }

          const row = document.createElement('tr');
          row.className = rowClass; // <-- add class to <tr>
          row.innerHTML = `
            <td>${bill.id}</td>
            <td>${bill.customerName}</td>
            <td>${bill.email || ''}</td>
            <td>${bill.address || ''}</td>
            <td>${bill.phone || ''}</td>
            <td>${bill.gstin || ''}</td>
            <td>${bill.dueDate || ''}</td>
            <td>${bill.amount.toFixed(2)}</td>
            <td>${paidStatus}</td>
            <td>${bill.mailsSent || 0}</td>
            <td><button class="toggle-paid" id="toggle-btn-${bill.id}" onclick="togglePaid(${bill.id})">Change Paid Status</button></td>
          `;
          tbody.appendChild(row);
          
        });

        initializeDataTable();

       drawReminderChart(bills);
       drawInvoicePieChart(paidBills.length, pendingBills.length);

      } catch (err) {
        console.error(err);
        alert("Error loading bills.");
      }
    }

    async function togglePaid(billId) {
  const btn = document.getElementById(`toggle-btn-${billId}`);
  const originalText = btn.innerHTML;

  // Disable button and show loader
  btn.disabled = true;
  btn.innerHTML = `
    Processing...
    <span style="
      display:inline-block;
      border:3px solid #f3f3f3;
      border-top:3px solid #4285F4;
      border-radius:50%;
      width:14px;
      height:14px;
      animation:spin 1s linear infinite;
      margin-left:8px;
      vertical-align:middle;
    "></span>
  `;

  try {
    const response = await fetch(`/api/update-paid-status/${billId}`, { method: 'PUT' });
    if (!response.ok) throw new Error("Failed to update paid status");

    // Remember current section
    localStorage.setItem('activeSection', 'invoices');
    window.location.reload();
  } catch (err) {
    console.error(err);
    alert("Error updating paid status.");
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}




    async function loadUserInfo() {
      try {
        const response = await fetch('/api/user-info');
        if (!response.ok) throw new Error("User not logged in");
        const user = await response.json();
        document.getElementById("user-name").textContent = user.name || "User";
        document.getElementById("project-name").textContent = user.project ? `Project: ${user.project}` : "";
      } catch (err) {
        console.error("Error loading user info:", err);
        document.getElementById("user-name").textContent = "User";
      }
    }

    // Charts
    let reminderChartInstance = null;
    let pieChartInstance = null;

    function drawReminderChart(bills) {
  const ctx = document.getElementById('reminders-chart').getContext('2d');
  const data = {
    labels: bills.slice(0, 6).map(b => b.customerName || 'Invoice'),
    datasets: [{
      label: 'Emails Sent',
      data: bills.slice(0, 6).map(b => b.mailsSent || 0),
      borderColor: '#4285F4',
      backgroundColor: 'rgba(66, 133, 244, 0.1)',
      tension: 0.4,
      fill: true,
      pointBackgroundColor: '#4285F4',
      pointRadius: 4,
      pointHoverRadius: 6
    }]
  };
  if (reminderChartInstance) reminderChartInstance.destroy();
  reminderChartInstance = new Chart(ctx, {
    type: 'line',
    data,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
    }
  });
}

    function drawInvoicePieChart(fulfilled, unfulfilled) {
      const ctx = document.getElementById('invoice-pie-chart').getContext('2d');
      const data = {
        labels: ['Fulfilled', 'Unfulfilled'],
        datasets: [{
          data: [fulfilled, unfulfilled],
          backgroundColor: ['#4285F4', '#D3D3D3'],
          borderWidth: 0
        }]
      };
      if (pieChartInstance) pieChartInstance.destroy();
      pieChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data,
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
      });
    }

    // Generate Bill Form Handler
    document.addEventListener("DOMContentLoaded", () => {
      loadBills();
      loadUserInfo();

        const lastSection = localStorage.getItem('activeSection') || 'dashboard';
        showSection(lastSection);
        localStorage.removeItem('activeSection');

      // Handle Generate Bill form submission
      const billForm = document.getElementById('billForm');
      const generateBtn = document.getElementById('generateBillBtn');
      const statusDiv = document.getElementById('billGenerateStatus');

      billForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        generateBtn.disabled = true;
        generateBtn.innerHTML = 'Processing... <span style="display:inline-block; border:3px solid #f3f3f3; border-top:3px solid white; border-radius:50%; width:16px; height:16px; animation:spin 1s linear infinite; margin-left:8px; vertical-align:middle;"></span>';
        
        statusDiv.style.display = 'block';
        statusDiv.textContent = 'Generating bill, please wait...';
        statusDiv.style.background = '#d1ecf1';
        statusDiv.style.color = '#0c5460';
        statusDiv.style.border = '1px solid #bee5eb';
        
        try {
          const formData = new FormData(billForm);
          const response = await fetch('/api/download-bill', {
            method: 'POST',
            body: formData
          });
          
          if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bill_${Date.now()}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            statusDiv.textContent = 'Bill generated successfully!';
            statusDiv.style.background = '#d4edda';
            statusDiv.style.color = '#155724';
            statusDiv.style.border = '1px solid #c3e6cb';
            
            billForm.reset();
            
            setTimeout(() => {
              statusDiv.style.display = 'none';
            }, 3000);
          } else {
            throw new Error('Failed to generate bill');
          }
        } catch (error) {
          statusDiv.textContent = 'Error generating bill: ' + error.message;
          statusDiv.style.background = '#f8d7da';
          statusDiv.style.color = '#721c24';
          statusDiv.style.border = '1px solid #f5c6cb';
        } finally {
          generateBtn.disabled = false;
          generateBtn.innerHTML = 'Generate Bill';
        }
      });

      // Bulk Upload Form Handler
      const bulkUploadForm = document.getElementById('bulkUploadForm');
      const uploadStatusDiv = document.getElementById('uploadStatus');
      const uploadBtn = document.getElementById('uploadBtn');

      bulkUploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const fileInput = document.getElementById('file');
        const ownerEmail = document.getElementById('ownerEmail').value;
        const file = fileInput.files[0];
        
        if (!file) {
          showUploadStatus('Please select a file', 'error');
          return;
        }
        
        if (!file.name.endsWith('.xlsx')) {
          showUploadStatus('Please upload a valid Excel file (.xlsx)', 'error');
          return;
        }
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('ownerEmail', ownerEmail);
        
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = 'Uploading... <span style="display:inline-block; border:3px solid #f3f3f3; border-top:3px solid white; border-radius:50%; width:16px; height:16px; animation:spin 1s linear infinite; margin-left:8px; vertical-align:middle;"></span>';
        showUploadStatus('Uploading file, please wait...', 'info');
        
        try {
          const response = await fetch('/api/upload', {
            method: 'POST',
            body: formData
          });
          
          const result = await response.text();
          
          if (response.ok) {
            showUploadStatus(result || 'File uploaded and data imported successfully!', 'success');
            bulkUploadForm.reset();
            setTimeout(() => {
              loadBills();
            }, 1000);
          } else {
            showUploadStatus(result || 'Upload failed. Please try again.', 'error');
          }
        } catch (error) {
          showUploadStatus('Network error: ' + error.message, 'error');
        } finally {
          uploadBtn.disabled = false;
          uploadBtn.innerHTML = 'Upload Excel';
        }
      });

      function showUploadStatus(message, type) {
        uploadStatusDiv.textContent = message;
        uploadStatusDiv.className = '';
        uploadStatusDiv.style.display = 'block';
        
        if (type === 'success') {
          uploadStatusDiv.style.background = '#d4edda';
          uploadStatusDiv.style.color = '#155724';
          uploadStatusDiv.style.border = '1px solid #c3e6cb';
          setTimeout(() => {
            uploadStatusDiv.style.display = 'none';
          }, 5000);
        } else if (type === 'error') {
          uploadStatusDiv.style.background = '#f8d7da';
          uploadStatusDiv.style.color = '#721c24';
          uploadStatusDiv.style.border = '1px solid #f5c6cb';
        } else if (type === 'info') {
          uploadStatusDiv.style.background = '#d1ecf1';
          uploadStatusDiv.style.color = '#0c5460';
          uploadStatusDiv.style.border = '1px solid #bee5eb';
        }
      }
    });
    // Initialize DataTable after bills are loaded
function initializeDataTable() {
  // Destroy existing instance if already initialized
  if ($.fn.DataTable.isDataTable('#billsTable')) {
    $('#billsTable').DataTable().destroy();
  }

  $('#billsTable').DataTable({
    paging: true,
    searching: true,      // Enables search bar
    ordering: true,       // Enables sorting on all columns
    order: [[0, 'desc']], // Default sort by Bill No descending
    columnDefs: [
      { orderable: false, targets: 10 } // Disable sorting on "Action" column (optional)
    ]
  });
}

document.getElementById('exportBtn').addEventListener('click', () => {
  const table = document.getElementById('billsTable');
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.table_to_sheet(table);
  XLSX.utils.book_append_sheet(wb, ws, "Invoices");

  XLSX.writeFile(wb, `invoices_${Date.now()}.xlsx`);
});


  </script>

  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</body>
</html>